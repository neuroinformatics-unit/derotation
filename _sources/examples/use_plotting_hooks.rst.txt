
.. DO NOT EDIT.
.. THIS FILE WAS AUTOMATICALLY GENERATED BY SPHINX-GALLERY.
.. TO MAKE CHANGES, EDIT THE SOURCE PYTHON FILE:
.. "examples/use_plotting_hooks.py"
.. LINE NUMBERS ARE GIVEN BELOW.

.. only:: html

    .. note::
        :class: sphx-glr-download-link-note

        :ref:`Go to the end <sphx_glr_download_examples_use_plotting_hooks.py>`
        to download the full example code. or to run this example in your browser via Binder

.. rst-class:: sphx-glr-example-title

.. _sphx_glr_examples_use_plotting_hooks.py:


Visualizing derotation line-by-line with custom hooks
=====================================================

This example demonstrates how to use a custom plotting hook to visualize how
each image frame is reconstructed during derotation, line by line.

The derotation process works by rotating each horizontal line of an image by a
given angle and placing it into a new derotated frame. Understanding this
process is useful both for debugging and for developing intuition about how
motion correction works.

In this example, we define a custom hook called after each line is processed
during derotation. The hook visualizes the following:

     - The original image, with the current line highlighted
    - The partially built derotated image
    - The currently rotated line, overlaid on the right-hand image (if
      visible)

The hook is triggered only for frame 135 and every 20 lines, to keep the output
readable.

This can be particularly helpful when:
    - You want to verify that the rotation mapping is working as expected
    - You want to debug center of rotation or interpolation artifacts
    - You are developing your own hooks or modifying the pipeline internals

.. GENERATED FROM PYTHON SOURCE LINES 31-33

Imports
-------

.. GENERATED FROM PYTHON SOURCE LINES 33-42

.. code-block:: Python


    from pathlib import Path

    import matplotlib.pyplot as plt
    import numpy as np

    from derotation.analysis.full_derotation_pipeline import FullPipeline
    from derotation.config.load_config import load_config, update_config_paths








.. GENERATED FROM PYTHON SOURCE LINES 43-46

Load and configure paths
------------------------
We'll use a small example dataset and write output to the current folder.

.. GENERATED FROM PYTHON SOURCE LINES 46-60

.. code-block:: Python


    current_module_path = Path.cwd()
    data_folder = current_module_path / "data"
    output_folder = current_module_path

    config = load_config()
    config = update_config_paths(
        config=config,
        tif_path=str(data_folder / "rotation_sample.tif"),
        aux_path=str(data_folder / "analog_signals.npy"),
        stim_randperm_path=str(data_folder / "stimulus_randperm.csv"),
        output_folder=str(output_folder),
    )








.. GENERATED FROM PYTHON SOURCE LINES 61-67

Define a custom hook function
-----------------------------
This hook is called after every line is derotated and placed into the new
frame. We'll use it to inspect how frame 135 is constructed over time.
This is a simplified version of the hook
:func:`derotation.plotting_hooks.for_derotation.line_addition`.

.. GENERATED FROM PYTHON SOURCE LINES 67-110

.. code-block:: Python



    def inspect_frame_135_and_line_180(
        derotated_filled_image: np.ndarray,
        rotated_line: np.ndarray,
        image_counter: int,
        line_counter: int,
        angle: float,
        original_image: np.ndarray,
    ):
        if image_counter == 135 and line_counter == 180:
            fig, ax = plt.subplots(1, 2, figsize=(10, 5))
            #  background fig color: black
            fig.patch.set_facecolor("black")

            ax[0].imshow(original_image, cmap="turbo")
            #  highlight the line in the original image
            ax[0].plot(
                [0, original_image.shape[1] - 1],
                [line_counter, line_counter],
                color="red",
                linewidth=2,
            )
            ax[0].set_title(
                f"Take line {line_counter}\nfrom original image,\n then rotate it"
                f"of {angle:.2f} degrees"
            )
            ax[0].title.set_color("white")
            ax[0].axis("off")

            ax[1].imshow(derotated_filled_image, cmap="turbo")
            ax[1].set_title(
                f"Place the line in a new image\nto build frame {image_counter}"
            )
            ax[1].title.set_color("white")
            ax[1].axis("off")

            #  plot on top axis 1 the rotated_line with a red colormap
            ax[1].imshow(rotated_line, cmap="hsv", alpha=0.5)

            plt.show()









.. GENERATED FROM PYTHON SOURCE LINES 111-113

Register the hook
-----------------

.. GENERATED FROM PYTHON SOURCE LINES 113-118

.. code-block:: Python


    hooks = {
        "plotting_hook_line_addition": inspect_frame_135_and_line_180,
    }








.. GENERATED FROM PYTHON SOURCE LINES 119-122

Run the derotation pipeline with the custom hook
------------------------------------------------
Our hook will be called during processing of each line.

.. GENERATED FROM PYTHON SOURCE LINES 122-127

.. code-block:: Python


    pipeline = FullPipeline(config)
    pipeline.hooks = hooks
    pipeline()




.. image-sg:: /examples/images/sphx_glr_use_plotting_hooks_001.png
   :alt: Take line 180 from original image,  then rotate itof 85.18 degrees, Place the line in a new image to build frame 135
   :srcset: /examples/images/sphx_glr_use_plotting_hooks_001.png
   :class: sphx-glr-single-img


.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    2025-04-08 14:58:50 PM INFO     2025-04-08 14:58:50 PM - INFO -  fancylog.py:326
                                    MainProcess fancylog.py:326 -                   
                                    Starting logging                                
                           INFO     2025-04-08 14:58:50 PM - INFO -  fancylog.py:327
                                    MainProcess fancylog.py:327 -                   
                                    Not logging multiple processes                  
                           INFO     2025-04-08       full_derotation_pipeline.py:164
                                    14:58:50 PM -                                   
                                    INFO -                                          
                                    MainProcess                                     
                                    full_derotation_                                
                                    pipeline.py:164                                 
                                    - Loading                                       
                                    data...                                         
                           INFO     2025-04-08       full_derotation_pipeline.py:165
                                    14:58:50 PM -                                   
                                    INFO -                                          
                                    MainProcess                                     
                                    full_derotation_                                
                                    pipeline.py:165                                 
                                    - Loading                                       
                                    /home/runner/wor                                
                                    k/derotation/der                                
                                    otation/examples                                
                                    /data/rotation_s                                
                                    ample.tif                                       
                           INFO     2025-04-08       full_derotation_pipeline.py:186
                                    14:58:50 PM -                                   
                                    INFO -                                          
                                    MainProcess                                     
                                    full_derotation_                                
                                    pipeline.py:186                                 
                                    - Number of                                     
                                    rotations: 2                                    
                           INFO     2025-04-08       full_derotation_pipeline.py:194
                                    14:58:50 PM -                                   
                                    INFO -                                          
                                    MainProcess                                     
                                    full_derotation_                                
                                    pipeline.py:194                                 
                                    - Rotation                                      
                                    direction:                                      
                                    speed      200                                  
                                    direction                                       
                                    -1           1                                  
                                     1           1                                  
                           INFO     2025-04-08       full_derotation_pipeline.py:253
                                    14:58:50 PM -                                   
                                    INFO -                                          
                                    MainProcess                                     
                                    full_derotation_                                
                                    pipeline.py:253                                 
                                    - Deleting                                      
                                    previous debug                                  
                                    plots...                                        
                           INFO     2025-04-08       full_derotation_pipeline.py:263
                                    14:58:50 PM -                                   
                                    INFO -                                          
                                    MainProcess                                     
                                    full_derotation_                                
                                    pipeline.py:263                                 
                                    - Dataset                                       
                                    rotation_sample                                 
                                    loaded                                          
                           INFO     2025-04-08       full_derotation_pipeline.py:264
                                    14:58:50 PM -                                   
                                    INFO -                                          
                                    MainProcess                                     
                                    full_derotation_                                
                                    pipeline.py:264                                 
                                    - Filename:                                     
                                    derotated                                       
                           INFO     2025-04-08       full_derotation_pipeline.py:361
                                    14:58:50 PM -                                   
                                    INFO -                                          
                                    MainProcess                                     
                                    full_derotation_                                
                                    pipeline.py:361                                 
                                    - Finding                                       
                                    rotation ticks                                  
                                    peaks...                                        
                           INFO     2025-04-08       full_derotation_pipeline.py:436
                                    14:58:50 PM -                                   
                                    INFO -                                          
                                    MainProcess                                     
                                    full_derotation_                                
                                    pipeline.py:436                                 
                                    - Cleaning start                                
                                    and end rotation                                
                                    signal...                                       
                           INFO     2025-04-08       full_derotation_pipeline.py:461
                                    14:58:50 PM -                                   
                                    INFO -                                          
                                    MainProcess                                     
                                    full_derotation_                                
                                    pipeline.py:461                                 
                                    - Creating                                      
                                    signed rotation                                 
                                    array...                                        
                           INFO     2025-04-08       full_derotation_pipeline.py:483
                                    14:58:50 PM -                                   
                                    INFO -                                          
                                    MainProcess                                     
                                    full_derotation_                                
                                    pipeline.py:483                                 
                                    - Dropping ticks                                
                                    outside of the                                  
                                    rotation                                        
                                    period...                                       
                           INFO     2025-04-08       full_derotation_pipeline.py:519
                                    14:58:50 PM -                                   
                                    INFO -                                          
                                    MainProcess                                     
                                    full_derotation_                                
                                    pipeline.py:519                                 
                                    - Ticks dropped:                                
                                    1.                                              
                                    Ticks remaining:                                
                                    3451                                            
                           INFO     2025-04-08       full_derotation_pipeline.py:550
                                    14:58:50 PM -                                   
                                    INFO -                                          
                                    MainProcess                                     
                                    full_derotation_                                
                                    pipeline.py:550                                 
                                    - Number of                                     
                                    rotations is as                                 
                                    expected                                        
                           WARNING  2025-04-08       full_derotation_pipeline.py:597
                                    14:58:50 PM -                                   
                                    WARNING -                                       
                                    MainProcess                                     
                                    full_derotation_                                
                                    pipeline.py:597                                 
                                    - Number of                                     
                                    ticks is not as                                 
                                    expected: 3451.                                 
                                    Expected ticks:                                 
                                    3600.0                                          
                                    Delta: -149.0                                   
                           INFO     2025-04-08       full_derotation_pipeline.py:649
                                    14:58:50 PM -                                   
                                    INFO -                                          
                                    MainProcess                                     
                                    full_derotation_                                
                                    pipeline.py:649                                 
                                    - New increment                                 
                                    example: 0.209                                  
                           INFO     2025-04-08       full_derotation_pipeline.py:662
                                    14:58:50 PM -                                   
                                    INFO -                                          
                                    MainProcess                                     
                                    full_derotation_                                
                                    pipeline.py:662                                 
                                    - Interpolating                                 
                                    angles...                                       
                           INFO     2025-04-08       full_derotation_pipeline.py:702
                                    14:58:50 PM -                                   
                                    INFO -                                          
                                    MainProcess                                     
                                    full_derotation_                                
                                    pipeline.py:702                                 
                                    - Cleaning                                      
                                    interpolated                                    
                                    angles...                                       
                           INFO     2025-04-08       full_derotation_pipeline.py:761
                                    14:58:50 PM -                                   
                                    INFO -                                          
                                    MainProcess                                     
                                    full_derotation_                                
                                    pipeline.py:761                                 
                                    - Calculating                                   
                                    angles by line                                  
                                    and frame...                                    
                           INFO     2025-04-08       full_derotation_pipeline.py:856
                                    14:58:50 PM -                                   
                                    INFO -                                          
                                    MainProcess                                     
                                    full_derotation_                                
                                    pipeline.py:856                                 
                                    - Plotting                                      
                                    rotation ticks                                  
                                    and rotation on                                 
                                    signal...                                       
    2025-04-08 14:58:51 PM INFO     2025-04-08       full_derotation_pipeline.py:898
                                    14:58:51 PM -                                   
                                    INFO -                                          
                                    MainProcess                                     
                                    full_derotation_                                
                                    pipeline.py:898                                 
                                    - Plotting                                      
                                    rotation                                        
                                    angles...                                       
                           INFO     2025-04-08       full_derotation_pipeline.py:901
                                    14:58:51 PM -                                   
                                    INFO -                                          
                                    MainProcess                                     
                                    full_derotation_                                
                                    pipeline.py:901                                 
                                    - Speeds:                                       
                                    {np.int64(200)}                                 
                           INFO     2025-04-08       full_derotation_pipeline.py:902
                                    14:58:51 PM -                                   
                                    INFO -                                          
                                    MainProcess                                     
                                    full_derotation_                                
                                    pipeline.py:902                                 
                                    - len (speeds):                                 
                                    1                                               
                           INFO     2025-04-08       full_derotation_pipeline.py:348
                                    14:58:51 PM -                                   
                                    INFO -                                          
                                    MainProcess                                     
                                    full_derotation_                                
                                    pipeline.py:348                                 
                                    - ✨ Analog                                     
                                    signals                                         
                                    processed ✨                                    
                           INFO     2025-04-08      full_derotation_pipeline.py:1121
                                    14:58:51 PM -                                   
                                    INFO -                                          
                                    MainProcess                                     
                                    full_derotation                                 
                                    _pipeline.py:11                                 
                                    21 - Optimal                                    
                                    center of                                       
                                    rotation read                                   
                                    from file.                                      
                           INFO     2025-04-08      full_derotation_pipeline.py:1167
                                    14:58:51 PM -                                   
                                    INFO -                                          
                                    MainProcess                                     
                                    full_derotation                                 
                                    _pipeline.py:11                                 
                                    67 - Starting                                   
                                    derotation by                                   
                                    line...                                         
                           INFO     2025-04-08      full_derotation_pipeline.py:1135
                                    14:58:51 PM -                                   
                                    INFO -                                          
                                    MainProcess                                     
                                    full_derotation                                 
                                    _pipeline.py:11                                 
                                    35 - Plotting                                   
                                    max projection                                  
                                    with center...                                  
      0%|          | 0/69120 [00:00<?, ?it/s]     47%|████▋     | 32378/69120 [00:00<00:00, 323767.19it/s]     94%|█████████▎| 64755/69120 [00:01<00:00, 55812.08it/s]     100%|██████████| 69120/69120 [00:01<00:00, 67111.16it/s]
    2025-04-08 14:58:52 PM INFO     2025-04-08      full_derotation_pipeline.py:1135
                                    14:58:52 PM -                                   
                                    INFO -                                          
                                    MainProcess                                     
                                    full_derotation                                 
                                    _pipeline.py:11                                 
                                    35 - Plotting                                   
                                    max projection                                  
                                    with center...                                  
                           INFO     2025-04-08      full_derotation_pipeline.py:1198
                                    14:58:52 PM -                                   
                                    INFO -                                          
                                    MainProcess                                     
                                    full_derotation                                 
                                    _pipeline.py:11                                 
                                    98 - ✨ Image                                   
                                    stack derotated                                 
                                    ✨                                              
    /opt/hostedtoolcache/Python/3.12.9/x64/lib/python3.12/site-packages/numpy/_core/fromnumeric.py:3860: RuntimeWarning: Mean of empty slice.
      return _methods._mean(a, axis=axis, dtype=dtype,
    /opt/hostedtoolcache/Python/3.12.9/x64/lib/python3.12/site-packages/numpy/_core/_methods.py:137: RuntimeWarning: invalid value encountered in divide
      ret = um.true_divide(
    2025-04-08 14:58:55 PM INFO     2025-04-08      full_derotation_pipeline.py:1338
                                    14:58:55 PM -                                   
                                    INFO -                                          
                                    MainProcess                                     
                                    full_derotation                                 
                                    _pipeline.py:13                                 
                                    38 - Saving                                     
                                    /home/runner/wo                                 
                                    rk/derotation/d                                 
                                    erotation/examp                                 
                                    les/derotation/                                 
                                    derotated.tif                                   
                           WARNING  2025-04-08      full_derotation_pipeline.py:1357
                                    14:58:55 PM -                                   
                                    WARNING -                                       
                                    MainProcess                                     
                                    full_derotation                                 
                                    _pipeline.py:13                                 
                                    57 - Number of                                  
                                    rotation angles                                 
                                    by frame is                                     
                                    higher than the                                 
                                    number of                                       
                                    frames                                          





.. rst-class:: sphx-glr-timing

   **Total running time of the script:** (0 minutes 6.115 seconds)


.. _sphx_glr_download_examples_use_plotting_hooks.py:

.. only:: html

  .. container:: sphx-glr-footer sphx-glr-footer-example

    .. container:: binder-badge

      .. image:: images/binder_badge_logo.svg
        :target: https://mybinder.org/v2/gh/neuroinformatics-unit/derotation/gh-pages?filepath=notebooks/examples/use_plotting_hooks.ipynb
        :alt: Launch binder
        :width: 150 px

    .. container:: sphx-glr-download sphx-glr-download-jupyter

      :download:`Download Jupyter notebook: use_plotting_hooks.ipynb <use_plotting_hooks.ipynb>`

    .. container:: sphx-glr-download sphx-glr-download-python

      :download:`Download Python source code: use_plotting_hooks.py <use_plotting_hooks.py>`

    .. container:: sphx-glr-download sphx-glr-download-zip

      :download:`Download zipped: use_plotting_hooks.zip <use_plotting_hooks.zip>`


.. only:: html

 .. rst-class:: sphx-glr-signature

    `Gallery generated by Sphinx-Gallery <https://sphinx-gallery.github.io>`_
