
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Key Concepts &#8212; Derotation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery.css?v=d2d258e8" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-binder.css?v=f4aeca0c" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-dataframe.css?v=2082cf3c" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-rendered-html.css?v=1277b6f3" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../_static/css/custom.css?v=8d03875c" />
  
  <!-- So that users can add custom icons -->
  <script src="../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../_static/documentation_options.js?v=59fadc99"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'user_guide/key_concepts';</script>
    <link rel="canonical" href="https://derotation.neuroinformatics.dev/user_guide/key_concepts.html" />
    <link rel="icon" href="../_static/light-logo-niu.png"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
  
    <p class="title logo__title">derotation v0.1.5</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="index.html">
    User Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../examples/index.html">
    Examples
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../contributing.html">
    Contributing Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../api_index.html">
    API Reference
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/neuroinformatics-unit/derotation" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://neuroinformatics.zulipchat.com/#narrow/channel/495735-Derotation" title="Zulip (chat)" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-solid fa-comments fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Zulip (chat)</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
    <button class="pst-navbar-icon sidebar-toggle secondary-toggle" aria-label="On this page">
      <span class="fa-solid fa-outdent"></span>
    </button>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="index.html">
    User Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../examples/index.html">
    Examples
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../contributing.html">
    Contributing Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../api_index.html">
    API Reference
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/neuroinformatics-unit/derotation" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://neuroinformatics.zulipchat.com/#narrow/channel/495735-Derotation" title="Zulip (chat)" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-solid fa-comments fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Zulip (chat)</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">Key Concepts</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="key-concepts">
<span id="user-guide-key-concepts"></span><h1>Key Concepts<a class="headerlink" href="#key-concepts" title="Link to this heading">#</a></h1>
<p><code class="docutils literal notranslate"><span class="pre">derotation</span></code> is a modular package for reconstructing rotating image stacks acquired via line scanning microscopes. This page covers the core ideas, flow of information, and how the main modules interact.
See the <a class="reference internal" href="../api_index.html"><span class="std std-doc">API documentation</span></a> for a detailed overview of the package.</p>
<section id="how-derotation-works">
<h2>How derotation works<a class="headerlink" href="#how-derotation-works" title="Link to this heading">#</a></h2>
<p>Without derotation, movies acquired with a line scanning microscope are geometrically distorted — each line is captured at a slightly different angle, making it hard to register or interpret the resulting images.</p>
<figure class="align-default" id="id1">
<img alt="../_images/derotation_index.png" src="../_images/derotation_index.png" />
<figcaption>
<p><span class="caption-text"><strong>Left:</strong> schematic of a line-scanning microscope acquiring an image of a grid. The scanning pattern plus the sample rotation lead fan-like aftefacts. <strong>Right:</strong> grid that has been imaged while still (top), while rotating (middle) and the derotated image (bottom). The grid is now perfectly aligned.</span><a class="headerlink" href="#id1" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p>If the angle of rotation is recorded, <code class="docutils literal notranslate"><span class="pre">derotation</span></code> can reconstruct each frame by assigning a rotation angle to each acquired line and rotating it back to its original position. This is what is called derotation-by-line. This process incrementally reconstructs each frame and can optionally include shear deformation correction.</p>
<figure class="align-default" id="id2">
<img alt="../_images/derotation_by_line.gif" src="../_images/derotation_by_line.gif" />
<figcaption>
<p><span class="caption-text">Reconstruction of a frame with derotation. The original frame with deformation is on the left. With subsequent iterations, derotation picks a line, rotates it according to the calculated angle, and adds it to the new derotated frame. The final result is on the right.</span><a class="headerlink" href="#id2" title="Link to this image">#</a></p>
</figcaption>
</figure>
</section>
<section id="how-to-use-derotation">
<h2>How to use derotation<a class="headerlink" href="#how-to-use-derotation" title="Link to this heading">#</a></h2>
<p>There are two main ways to use <code class="docutils literal notranslate"><span class="pre">derotation</span></code>:</p>
<section id="low-level-core-function">
<h3>1. <strong>Low-level core function</strong><a class="headerlink" href="#low-level-core-function" title="Link to this heading">#</a></h3>
<p>Use <a class="reference internal" href="../api/derotation.derotate_by_line.html#derotation.derotate_by_line.derotate_an_image_array_line_by_line" title="derotation.derotate_by_line.derotate_an_image_array_line_by_line"><code class="xref py py-func docutils literal notranslate"><span class="pre">derotation.derotate_by_line.derotate_an_image_array_line_by_line()</span></code></a> to derotate an image stack, given:</p>
<ul class="simple">
<li><p>The original multi-photon movie (expects only one imaging plane)</p></li>
<li><p>Rotation angle per line</p></li>
</ul>
<p>This is ideal for testing and debugging with synthetic or preprocessed data.</p>
<p>Please refer to the <a class="reference internal" href="../examples/core_function.html"><span class="std std-doc">example on how to use the core function</span></a> for a demonstration of how to use <a class="reference internal" href="../api/derotation.derotate_by_line.html#derotation.derotate_by_line.derotate_an_image_array_line_by_line" title="derotation.derotate_by_line.derotate_an_image_array_line_by_line"><code class="xref py py-func docutils literal notranslate"><span class="pre">derotation.derotate_by_line.derotate_an_image_array_line_by_line()</span></code></a>.</p>
</section>
<section id="full-and-incremental-pipeline-classes">
<h3>2. <strong>Full and Incremental Pipeline Classes</strong><a class="headerlink" href="#full-and-incremental-pipeline-classes" title="Link to this heading">#</a></h3>
<p>Derotation provides two pre-built pipelines for end-to-end processing:</p>
<ul class="simple">
<li><p><strong><a class="reference internal" href="../api/derotation.analysis.full_derotation_pipeline.html#derotation.analysis.full_derotation_pipeline.FullPipeline" title="derotation.analysis.full_derotation_pipeline.FullPipeline"><code class="xref py py-class docutils literal notranslate"><span class="pre">derotation.analysis.full_derotation_pipeline.FullPipeline</span></code></a></strong>
Assumes randomized, alternating clockwise and counter-clockwise rotations. It performs:</p>
<ul>
<li><p>Analog signal parsing</p></li>
<li><p>Angle interpolation</p></li>
<li><p>Bayesian optimization for center estimation</p></li>
<li><p>Line-by-line derotation using <a class="reference internal" href="../api/derotation.derotate_by_line.html#derotation.derotate_by_line.derotate_an_image_array_line_by_line" title="derotation.derotate_by_line.derotate_an_image_array_line_by_line"><code class="xref py py-func docutils literal notranslate"><span class="pre">derotation.derotate_by_line.derotate_an_image_array_line_by_line()</span></code></a></p></li>
</ul>
</li>
<li><p><strong><a class="reference internal" href="../api/derotation.analysis.incremental_derotation_pipeline.html#derotation.analysis.incremental_derotation_pipeline.IncrementalPipeline" title="derotation.analysis.incremental_derotation_pipeline.IncrementalPipeline"><code class="xref py py-class docutils literal notranslate"><span class="pre">derotation.analysis.incremental_derotation_pipeline.IncrementalPipeline</span></code></a></strong>
Assumes a continuous rotation performed in small increments. Inherits from <code class="docutils literal notranslate"><span class="pre">FullPipeline</span></code> but skips Bayesian optimization.
Useful when the center of rotation is known or estimated differently.</p></li>
</ul>
<p>Both pipelines accept a <strong>configuration dictionary</strong> (see the <a class="reference internal" href="configuration.html"><span class="std std-doc">configuration guide</span></a>) and produce:</p>
<ul class="simple">
<li><p>A derotated TIFF stack</p></li>
<li><p>A CSV file with rotation angles and metadata</p></li>
<li><p>Debugging plots</p></li>
<li><p>A text file containing the estimated optimal center of rotation</p></li>
<li><p>Log files</p></li>
</ul>
<p>You can create custom pipelines by subclassing <code class="docutils literal notranslate"><span class="pre">FullPipeline</span></code> and overriding the relevant methods.</p>
<p>See the <a class="reference internal" href="../examples/pipeline_with_real_data.html"><span class="std std-doc">usage example</span></a> for how to instantiate <code class="docutils literal notranslate"><span class="pre">FullPipeline</span></code>, run it, and inspect its attributes and outputs.</p>
</section>
<hr class="docutils" />
<section id="data-format-and-requirements">
<h3>Data Format and Requirements<a class="headerlink" href="#data-format-and-requirements" title="Link to this heading">#</a></h3>
<p>These pipelines are designed for a specific experimental setup. They expect analog input signals in a fixed order and may not work out-of-the-box with custom data.</p>
<p>The following inputs are required:</p>
<ul>
<li><p>A <strong>numpy array</strong> of analog signals, with four channels in this order:</p>
<ol class="arabic simple">
<li><p><strong>Line clock</strong> – signals the start of a new line (from ScanImage)</p></li>
<li><p><strong>Frame clock</strong> – signals the start of a new frame (from ScanImage)</p></li>
<li><p><strong>Rotation ON signal</strong> – indicates when the motor is rotating</p></li>
<li><p><strong>Rotation ticks</strong> – used to compute rotation angles (from the step motor)</p></li>
</ol>
</li>
<li><p>A <strong>CSV file</strong> describing speeds and directions of rotation in the following format:</p>
<div class="highlight-csv notranslate"><div class="highlight"><pre><span></span>speed,direction
200,-1
200,1
</pre></div>
</div>
</li>
</ul>
<p>Refer to the <a class="reference internal" href="configuration.html"><span class="std std-doc">configuration guide</span></a> for more details on specifying file paths and parameters.</p>
</section>
</section>
<hr class="docutils" />
<section id="finding-the-center-of-rotation">
<h2>Finding the center of rotation<a class="headerlink" href="#finding-the-center-of-rotation" title="Link to this heading">#</a></h2>
<p>An accurate center of rotation is crucial for high-quality derotation. Even small errors can produce residual motion in the derotated movie — often visible as circles traced by stationary objects as cells.</p>
<figure class="align-default" id="id3">
<img alt="../_images/wrong_center.png" src="../_images/wrong_center.png" />
<figcaption>
<p><span class="caption-text">In this picture, you can see as red crosses the centers of one of the cells in the movie across different angles. Since the center is not correctly estimated, the cell appears to move in a circle.</span><a class="headerlink" href="#id3" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p>Derotation offers two approaches for estimating the center:</p>
<p><strong>Bayesian optimization via FullPipeline</strong></p>
<p>This method searches for the correct center of rotation by derotating the whole movie and minimizing a custom metric, computed through the function <a class="reference internal" href="../api/derotation.analysis.metrics.html#derotation.analysis.metrics.ptd_of_most_detected_blob" title="derotation.analysis.metrics.ptd_of_most_detected_blob"><code class="xref py py-func docutils literal notranslate"><span class="pre">derotation.analysis.metrics.ptd_of_most_detected_blob()</span></code></a>. It requires the average image of the derotated movie at different rotations angles, and from them detects blobs, searches for the most frequent and calculates the Point-to-Point Distance (PTD) for it across blob centers at different rotation angles.</p>
<p>It is robust but computationally expensive.</p>
<p><strong>Ellipse fitting via <a class="reference internal" href="../api/derotation.analysis.incremental_derotation_pipeline.html#derotation.analysis.incremental_derotation_pipeline.IncrementalPipeline" title="derotation.analysis.incremental_derotation_pipeline.IncrementalPipeline"><code class="xref py py-class docutils literal notranslate"><span class="pre">derotation.analysis.incremental_derotation_pipeline.IncrementalPipeline</span></code></a></strong></p>
<p>This method exploits the fact that incremental datasets rotate very slowly and smoothly. It works by:</p>
<ul class="simple">
<li><p>Calculate the mean image of the movie at 10 degree rotation intervals</p></li>
<li><p>Find the center of the largest blob in each mean image (see <a class="reference internal" href="../api/derotation.analysis.blob_detection.html#derotation.analysis.blob_detection.BlobDetection" title="derotation.analysis.blob_detection.BlobDetection"><code class="xref py py-class docutils literal notranslate"><span class="pre">derotation.analysis.blob_detection.BlobDetection</span></code></a>)</p></li>
<li><p>Fitting an ellipse to those centers (this would give you the center of the ellipse, but also the major and minor axes, and the angle of rotation; see the section on <a class="reference internal" href="#out-of-plane-rotations">out-of-plane rotations</a> for more details on how this information can be used)</p></li>
</ul>
<p>The center of the ellipse is assumed to match the true center of rotation. This method fails when the cell stops being visible in certain rotation angles.</p>
<p>Once the center is estimated, it can be fed to the <a class="reference internal" href="../api/derotation.analysis.full_derotation_pipeline.html#derotation.analysis.full_derotation_pipeline.FullPipeline" title="derotation.analysis.full_derotation_pipeline.FullPipeline"><code class="xref py py-class docutils literal notranslate"><span class="pre">derotation.analysis.full_derotation_pipeline.FullPipeline</span></code></a> to derotate the whole movie.</p>
</section>
<hr class="docutils" />
<section id="verifying-derotation-quality">
<h2>Verifying derotation quality<a class="headerlink" href="#verifying-derotation-quality" title="Link to this heading">#</a></h2>
<p>Use debugging plots and logs to assess the quality of your reconstruction. These include:</p>
<ul class="simple">
<li><p>Analog signal overlays</p></li>
<li><p>Angle interpolation traces</p></li>
<li><p>Center estimation visualizations</p></li>
<li><p>Derotated frame samples
Debugging plots are by default saved in the <code class="docutils literal notranslate"><span class="pre">debug_plots</span></code> folder.</p></li>
</ul>
<p>You can see some of the debugging plots in the <a class="reference internal" href="../examples/pipeline_with_real_data.html"><span class="std std-doc">example using real data</span></a> and the <a class="reference internal" href="../examples/find_center_of_rotation.html"><span class="std std-doc">example to find the center of rotation with synthetic data</span></a>.</p>
<section id="custom-plotting-hooks">
<h3>Custom plotting hooks<a class="headerlink" href="#custom-plotting-hooks" title="Link to this heading">#</a></h3>
<p>To monitor what is happening at every step of line-by-line derotation, you can use custom plotting hooks. These are functions that are called at specific points in the pipeline and can be used to visualize intermediate results.</p>
<p>There are two steps in the <a class="reference internal" href="../api/derotation.derotate_by_line.html#derotation.derotate_by_line.derotate_an_image_array_line_by_line" title="derotation.derotate_by_line.derotate_an_image_array_line_by_line"><code class="xref py py-func docutils literal notranslate"><span class="pre">derotation.derotate_by_line.derotate_an_image_array_line_by_line()</span></code></a> function where hooks can be injected:</p>
<ul class="simple">
<li><p>After adding a new line to the derotated image (<a class="reference internal" href="../api/derotation.plotting_hooks.for_derotation.html#derotation.plotting_hooks.for_derotation.line_addition" title="derotation.plotting_hooks.for_derotation.line_addition"><code class="xref py py-func docutils literal notranslate"><span class="pre">derotation.plotting_hooks.for_derotation.line_addition()</span></code></a>)</p></li>
<li><p>After completing a frame (<a class="reference internal" href="../api/derotation.plotting_hooks.for_derotation.html#derotation.plotting_hooks.for_derotation.image_completed" title="derotation.plotting_hooks.for_derotation.image_completed"><code class="xref py py-func docutils literal notranslate"><span class="pre">derotation.plotting_hooks.for_derotation.image_completed()</span></code></a>)</p></li>
</ul>
<blockquote>
<div><p>⚠️ Note: Hooks may slow down processing significantly. Use them for inspection only.
You can also inject <strong>custom plotting hooks</strong> at defined pipeline stages. See the examples page for a demonstration. <em>Note: hooks may significantly slow down processing.</em></p>
</div></blockquote>
<p>See the <a class="reference internal" href="../examples/use_plotting_hooks.html"><span class="std std-doc">plotting hooks example</span></a> for a demonstration of how to use a custom plotting hook.</p>
</section>
</section>
<hr class="docutils" />
<section id="simulated-data">
<h2>Simulated data<a class="headerlink" href="#simulated-data" title="Link to this heading">#</a></h2>
<p>Use the <a class="reference internal" href="../api/derotation.simulate.line_scanning_microscope.html#derotation.simulate.line_scanning_microscope.Rotator" title="derotation.simulate.line_scanning_microscope.Rotator"><code class="xref py py-class docutils literal notranslate"><span class="pre">derotation.simulate.line_scanning_microscope.Rotator</span></code></a> and <a class="reference internal" href="../api/derotation.simulate.synthetic_data.html#derotation.simulate.synthetic_data.SyntheticData" title="derotation.simulate.synthetic_data.SyntheticData"><code class="xref py py-class docutils literal notranslate"><span class="pre">derotation.simulate.synthetic_data.SyntheticData</span></code></a> classes to generate test data:</p>
<ul class="simple">
<li><p><a class="reference internal" href="../api/derotation.simulate.line_scanning_microscope.html#derotation.simulate.line_scanning_microscope.Rotator" title="derotation.simulate.line_scanning_microscope.Rotator"><code class="xref py py-class docutils literal notranslate"><span class="pre">derotation.simulate.line_scanning_microscope.Rotator</span></code></a>: applies line-by-line rotation to an image stack, simulating a rotating microscope. It can be used to generate challenging synthetic data that include wrong centers of rotation and out of imaging plane rotations.</p></li>
<li><p><a class="reference internal" href="../api/derotation.simulate.synthetic_data.html#derotation.simulate.synthetic_data.SyntheticData" title="derotation.simulate.synthetic_data.SyntheticData"><code class="xref py py-class docutils literal notranslate"><span class="pre">derotation.simulate.synthetic_data.SyntheticData</span></code></a>: creates fake cell images, assigns rotation angles, and generates synthetic stacks. This is especially useful for validating both the incremental and full pipelines under known conditions.</p></li>
</ul>
<figure class="align-default" id="id4">
<img alt="../_images/rotator.gif" src="../_images/rotator.gif" />
<figcaption>
<p><span class="caption-text">This animation shows the synthetic data generated with the Rotator class. As you can see these are two “cells” that rotate around a given center of rotation.</span><a class="headerlink" href="#id4" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p>This is an example of a synthetic dataset with two cells generated with the <a class="reference internal" href="../api/derotation.simulate.line_scanning_microscope.html#derotation.simulate.line_scanning_microscope.Rotator" title="derotation.simulate.line_scanning_microscope.Rotator"><code class="xref py py-class docutils literal notranslate"><span class="pre">derotation.simulate.line_scanning_microscope.Rotator</span></code></a> class.</p>
<section id="out-of-plane-rotations">
<h3>Out-of-plane rotations<a class="headerlink" href="#out-of-plane-rotations" title="Link to this heading">#</a></h3>
<p>A particularly interesting case is when the simulated rotation occurs <em>out of plane</em>, meaning the plane of rotation is not aligned with the imaging plane. In this scenario, the projection of the true 3D rotation onto the 2D imaging plane results in an <strong>elliptical trajectory</strong> for each cell, rather than a perfect circular path. This trajectory can be captured with the SyntheticData class, or on real data with the IncrementalPipeline class, as the centers of a given cell across different rotation frames. Fitting an ellipse to these points will provide a quantitative estimate of the underlying rotation geometry, including the <strong>center of rotation</strong>, <strong>orientation</strong>, and <strong>tilt angle</strong> of the rotation plane. Orientation refers to the angle of the ellipse in the image plane, which can be calculated from the fitted major and minor axis using the function <a class="reference internal" href="../api/derotation.analysis.fit_ellipse.html#derotation.analysis.fit_ellipse.derive_angles_from_ellipse_fits" title="derotation.analysis.fit_ellipse.derive_angles_from_ellipse_fits"><code class="xref py py-func docutils literal notranslate"><span class="pre">derotation.analysis.fit_ellipse.derive_angles_from_ellipse_fits()</span></code></a>. These parameters can then be used as inputs to the derotation algorithm—specifically by enabling the <code class="docutils literal notranslate"><span class="pre">use_homography</span></code> option—to perform a more accurate transformation back to the scanning plane. This approach improves derotation performance in cases where the specimen is rotating in 3D space relative to the imaging setup.</p>
<figure class="align-default" id="id5">
<img alt="../_images/out_of_plane.png" src="../_images/out_of_plane.png" />
<figcaption>
<p><span class="caption-text"><strong>Left:</strong> a representation of out of imaging plane rotation paired with the position of a cell at 0deg, 90 deg and 180 deg. <strong>Centre:</strong> Side view and <strong>Right:</strong> top view top view of the planes and their relationship with the ellipse that can be fitted to the cell positions.</span><a class="headerlink" href="#id5" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p>You can find different examples on how to use the Rotator and SyntheticData classes in the <a class="reference internal" href="../examples/index.html"><span class="std std-doc">examples page</span></a>:</p>
<ul class="simple">
<li><p><a class="reference internal" href="../examples/elliptical_rotations.html"><span class="std std-doc">Use the Rotator to create elliptically rotated data</span></a></p></li>
<li><p><a class="reference internal" href="../examples/find_center_of_rotation.html"><span class="std std-doc">Find center of rotation with synthetic data</span></a></p></li>
<li><p><a class="reference internal" href="../examples/rotate_and_derotate_a_square.html"><span class="std std-doc">Simple rotation and derotation of an image stack</span></a></p></li>
</ul>
<hr class="docutils" />
</section>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#how-derotation-works">How derotation works</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#how-to-use-derotation">How to use derotation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#low-level-core-function">1. <strong>Low-level core function</strong></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#full-and-incremental-pipeline-classes">2. <strong>Full and Incremental Pipeline Classes</strong></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#data-format-and-requirements">Data Format and Requirements</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#finding-the-center-of-rotation">Finding the center of rotation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#verifying-derotation-quality">Verifying derotation quality</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#custom-plotting-hooks">Custom plotting hooks</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#simulated-data">Simulated data</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#out-of-plane-rotations">Out-of-plane rotations</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item"><p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.1.3.
    <br/>
    </p>
    <p class="theme-version">
    Built with the
    <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a>
    0.16.1.
    </p></div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item"><div class="things-in-a-row">
    <a href="https://neuroinformatics.dev/">
        <img src="../_static/light-logo-niu.png" alt="NIU" class="only-light img-sponsor"/>
        <img src="../_static/dark-logo-niu.png" alt="NIU" class="only-dark img-sponsor"/>
    </a>
    <a href="https://www.sainsburywellcome.org/web/">
        <img src="../_static/light-logo-swc.png" alt="SWC" class="only-light img-sponsor"/>
        <img src="../_static/dark-logo-swc.png" alt="SWC" class="only-dark img-sponsor"/>
    </a>
    <a href="https://www.ucl.ac.uk/">
        <img src="../_static/light-logo-ucl.png" alt="UCL" class="only-light img-sponsor"/>
        <img src="../_static/dark-logo-ucl.png" alt="UCL" class="only-dark img-sponsor"/>
    </a>
</div></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>